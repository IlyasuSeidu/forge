// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id          String       @id
  name        String
  description String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tasks       Task[]
  executions  Execution[]
  artifacts   Artifact[]
  approvals   Approval[]
  appRequests AppRequest[]
}

model Task {
  id           String    @id
  projectId    String
  appRequestId String?
  title        String
  description  String
  status       String    @default("pending")
  executionId  String?
  startedAt    DateTime?
  finishedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([appRequestId])
  @@index([status])
  @@index([executionId])
}

model Execution {
  id           String           @id
  projectId    String
  appRequestId String?
  status       String           @default("idle")
  startedAt    DateTime?
  finishedAt   DateTime?
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events       ExecutionEvent[]
  approvals    Approval[]

  @@index([projectId])
  @@index([appRequestId])
  @@index([status])
}

model ExecutionEvent {
  id          String    @id
  executionId String
  type        String
  message     String
  createdAt   DateTime  @default(now())
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([createdAt])
}

model Artifact {
  id          String   @id
  projectId   String
  executionId String?
  taskId      String?
  path        String
  type        String
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([executionId])
  @@index([taskId])
}

model Approval {
  id           String     @id
  projectId    String
  executionId  String?
  appRequestId String?
  taskId       String?
  type         String
  status       String     @default("pending")
  reason       String?
  createdAt    DateTime   @default(now())
  resolvedAt   DateTime?
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  execution    Execution? @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([executionId])
  @@index([appRequestId])
  @@index([status])
}

model AppRequest {
  id                 String              @id
  projectId          String
  prompt             String
  status             String              @default("pending")
  prdPath            String?
  executionId        String?
  errorReason        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  verifications      Verification[]
  conductorState     ConductorState?
  foundrySession     FoundrySession?
  planningDocuments  PlanningDocument[]
  screenIndex        ScreenIndex?
  screenDefinitions  ScreenDefinition[]
  userRoleDefinition UserRoleDefinition?
  userJourneys       UserJourney[]
  screenMockups      ScreenMockup[]
  projectRuleSet     ProjectRuleSet?
  buildPrompts       BuildPrompt[]
  executionPlans     ExecutionPlan[]
  completionDecisions CompletionDecision[]

  @@index([projectId])
  @@index([status])
}

model ConductorState {
  id            String     @id
  appRequestId  String     @unique
  currentStatus String
  locked        Boolean    @default(false)
  awaitingHuman Boolean    @default(false)
  lastAgent     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  appRequest    AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([locked])
  @@index([awaitingHuman])
}

model FoundrySession {
  id               String            @id
  appRequestId     String            @unique
  status           String // "asking" | "awaiting_approval" | "approved"
  currentStep      Int               @default(0)
  answers          String // JSON string containing answers
  draftPrompt      String?

  // Immutability & Versioning (Production Hardening)
  basePromptVersion Int              @default(1)
  basePromptHash    String?          // SHA-256 hash of approved content
  approvedAt        DateTime?        // When prompt was approved
  approvedBy        String?          // "human" | "synthetic_founder"

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  appRequest       AppRequest        @relation(fields: [appRequestId], references: [id], onDelete: Cascade)
  syntheticAnswers SyntheticAnswer[]

  @@index([appRequestId])
  @@index([status])
  @@index([basePromptHash])
}

model SyntheticAnswer {
  id               String         @id
  appRequestId     String
  foundrySessionId String
  step             Int
  question         String
  proposedAnswer   String
  finalAnswer      String?
  status           String // "proposed" | "approved" | "adjusted"

  // Production Hardening - SyntheticAnswerContract
  contract         String  @default("{}")  // JSON: {proposedAnswer, confidence, reasoning, assumptions, suggestedAlternatives}
  requestHash      String  @default("")    // SHA-256 hash for deduplication

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  foundrySession   FoundrySession @relation(fields: [foundrySessionId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([foundrySessionId])
  @@index([status])
  @@index([requestHash])
}

model PlanningDocument {
  id           String     @id
  appRequestId String
  type         String // "MASTER_PLAN" | "IMPLEMENTATION_PLAN"
  content      String // Markdown string
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  documentVersion Int              @default(1)
  documentHash    String?          // SHA-256 hash of approved document
  sectionHashes   String           @default("{}") // JSON: {"vision": "hash", "targetAudience": "hash", ...}
  basePromptHash  String?          // Reference to Base Prompt this was derived from
  approvedBy      String?          // "human" | "synthetic_founder"

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([type])
  @@index([status])
  @@index([documentHash])
  @@index([basePromptHash])
}

model ScreenIndex {
  id           String     @id
  appRequestId String     @unique
  screens      String // JSON array of screen names
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  screenIndexVersion Int      @default(1)
  screenIndexHash    String?  // SHA-256 hash of approved index
  approvedBy         String?  // "human"
  basePromptHash     String   @default("") // Reference to Base Prompt
  planningDocsHash   String   @default("") // SHA-256 of Master + Implementation Plans

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
  @@index([screenIndexHash])
  @@index([basePromptHash])
}

model ScreenDefinition {
  id           String     @id
  appRequestId String
  screenName   String
  content      String // Markdown string
  order        Int
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  screenVersion    Int      @default(1)
  screenHash       String?  // SHA-256 hash of approved screen
  approvedBy       String?  // "human"
  screenIndexHash  String   @default("") // Reference to approved Screen Index
  basePromptHash   String   @default("") // Reference to Base Prompt
  planningDocsHash String   @default("") // SHA-256 of planning docs

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([order])
  @@index([status])
  @@index([screenHash])
  @@index([screenIndexHash])
}

model UserRoleDefinition {
  id           String     @id
  appRequestId String     @unique
  content      String // Markdown table
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  roleTableVersion  Int      @default(1)
  roleTableHash     String?  // SHA-256 hash of approved role table
  approvedBy        String?  // "human"
  basePromptHash    String   @default("") // Reference to Base Prompt
  planningDocsHash  String   @default("") // SHA-256 of Master + Implementation Plans
  screenIndexHash   String   @default("") // Reference to approved Screen Index

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
  @@index([roleTableHash])
  @@index([basePromptHash])
  @@index([screenIndexHash])
}

model UserJourney {
  id           String     @id
  appRequestId String
  roleName     String
  content      String // Markdown journey steps
  order        Int
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  journeyVersion    Int      @default(1)
  journeyHash       String?  // SHA-256 hash of approved journey
  approvedBy        String?  // "human"
  roleTableHash     String   @default("") // Reference to approved Role Table
  screenIndexHash   String   @default("") // Reference to approved Screen Index
  basePromptHash    String   @default("") // Reference to Base Prompt
  planningDocsHash  String   @default("") // SHA-256 of planning docs

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([order])
  @@index([status])
  @@index([journeyHash])
  @@index([roleTableHash])
  @@index([screenIndexHash])
}

model ScreenMockup {
  id             String     @id
  appRequestId   String
  screenName     String
  layoutType     String // "mobile" | "desktop"
  imagePath      String
  promptMetadata String // JSON string
  status         String // "draft" | "awaiting_approval" | "approved"
  createdAt      DateTime   @default(now())
  approvedAt     DateTime?
  appRequest     AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([screenName])
  @@index([status])
}

model ProjectRuleSet {
  id           String     @id
  appRequestId String     @unique
  content      String // Markdown document
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?
  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
}

model BuildPrompt {
  id            String  @id
  appRequestId  String
  title         String
  content       String // Markdown document
  sequenceIndex Int
  status        String // "draft" | "awaiting_approval" | "approved"
  feedback      String?

  // Execution contract fields
  allowedCreateFiles String @default("[]") // JSON array
  allowedModifyFiles String @default("[]") // JSON array
  forbiddenFiles     String @default("[]") // JSON array
  fullRewriteFiles   String @default("[]") // JSON array
  dependencyManifest String @default("{}") // JSON object
  modificationIntent String @default("{}") // JSON object

  createdAt  DateTime   @default(now())
  approvedAt DateTime?
  appRequest AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([sequenceIndex])
  @@index([status])
}

model ExecutionPlan {
  id            String   @id
  appRequestId  String
  buildPromptId String
  status        String   // "pending" | "approved" | "rejected"
  createdAt     DateTime @default(now())
  approvedAt    DateTime?

  appRequest    AppRequest      @relation(fields: [appRequestId], references: [id], onDelete: Cascade)
  units         ExecutionUnit[]

  @@index([appRequestId])
  @@index([buildPromptId])
  @@index([status])
}

model ExecutionUnit {
  id                 String   @id
  executionPlanId    String
  sequenceIndex      Int
  title              String
  description        String

  // Execution contract for this unit
  allowedCreateFiles String @default("[]") // JSON array
  allowedModifyFiles String @default("[]") // JSON array
  forbiddenFiles     String @default("[]") // JSON array
  fullRewriteFiles   String @default("[]") // JSON array
  dependencyChanges  String @default("{}") // JSON object
  modificationIntent String @default("{}") // JSON object

  status        String   // "pending" | "in_progress" | "completed" | "failed"
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  executionPlan ExecutionPlan @relation(fields: [executionPlanId], references: [id], onDelete: Cascade)

  @@index([executionPlanId])
  @@index([sequenceIndex])
  @@index([status])
}

model Verification {
  id           String     @id
  appRequestId String
  executionId  String
  status       String     @default("pending")
  errors       String?
  attempt      Int        @default(1)
  createdAt    DateTime   @default(now())
  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([executionId])
  @@index([status])
}

model CompletionDecision {
  id              String     @id
  appRequestId    String
  executionUnitId String?
  decisionType    String     // "proceed_to_next_unit" | "retry_with_repair" | "escalate_to_human" | "mark_completed" | "mark_failed"
  reason          String?
  createdAt       DateTime   @default(now())
  appRequest      AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([decisionType])
  @@index([createdAt])
}
