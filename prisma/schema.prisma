// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id          String       @id
  name        String
  description String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tasks       Task[]
  executions  Execution[]
  artifacts   Artifact[]
  approvals   Approval[]
  appRequests AppRequest[]
}

model Task {
  id           String    @id
  projectId    String
  appRequestId String?
  title        String
  description  String
  status       String    @default("pending")
  executionId  String?
  startedAt    DateTime?
  finishedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([appRequestId])
  @@index([status])
  @@index([executionId])
}

model Execution {
  id           String           @id
  projectId    String
  appRequestId String?
  status       String           @default("idle")
  startedAt    DateTime?
  finishedAt   DateTime?
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events       ExecutionEvent[]
  approvals    Approval[]

  @@index([projectId])
  @@index([appRequestId])
  @@index([status])
}

model ExecutionEvent {
  id          String    @id
  executionId String
  type        String
  message     String
  createdAt   DateTime  @default(now())
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([createdAt])
}

model Artifact {
  id          String   @id
  projectId   String
  executionId String?
  taskId      String?
  path        String
  type        String
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([executionId])
  @@index([taskId])
}

model Approval {
  id           String     @id
  projectId    String
  executionId  String?
  appRequestId String?
  taskId       String?
  type         String
  status       String     @default("pending")
  reason       String?
  createdAt    DateTime   @default(now())
  resolvedAt   DateTime?
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  execution    Execution? @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([executionId])
  @@index([appRequestId])
  @@index([status])
}

model AppRequest {
  id                 String              @id
  projectId          String
  prompt             String
  status             String              @default("pending")
  prdPath            String?
  executionId        String?
  errorReason        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  verifications      Verification[]
  verificationResults VerificationResult[]
  verificationReports VerificationReport[]
  repairPlans        RepairPlan[]
  repairExecutionLogs RepairExecutionLog[]
  conductorState     ConductorState?
  foundrySession     FoundrySession?
  planningDocuments  PlanningDocument[]
  screenIndex        ScreenIndex?
  screenDefinitions  ScreenDefinition[]
  userRoleDefinition UserRoleDefinition?
  userJourneys       UserJourney[]
  screenMockups      ScreenMockup[]
  visualExpansionContracts VisualExpansionContract[]
  visualNormalizationContracts VisualNormalizationContract[]
  visualCompositionContracts VisualCompositionContract[]
  visualCodeRenderingContracts VisualCodeRenderingContract[]
  projectRuleSet     ProjectRuleSet?
  buildPrompts       BuildPrompt[]
  executionPlans     ExecutionPlan[]
  completionDecisions CompletionDecision[]
  frameworkManifests FrameworkAssemblyManifest[]
  previewSessions    PreviewRuntimeSession[]

  @@index([projectId])
  @@index([status])
}

model ConductorState {
  id            String     @id
  appRequestId  String     @unique
  currentStatus String
  locked        Boolean    @default(false)
  awaitingHuman Boolean    @default(false)
  lastAgent     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  appRequest    AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([locked])
  @@index([awaitingHuman])
}

model FoundrySession {
  id               String            @id
  appRequestId     String            @unique
  status           String // "asking" | "awaiting_approval" | "approved"
  currentStep      Int               @default(0)
  answers          String // JSON string containing answers
  draftPrompt      String?

  // Immutability & Versioning (Production Hardening)
  basePromptVersion Int              @default(1)
  basePromptHash    String?          // SHA-256 hash of approved content
  approvedAt        DateTime?        // When prompt was approved
  approvedBy        String?          // "human" | "synthetic_founder"

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  appRequest       AppRequest        @relation(fields: [appRequestId], references: [id], onDelete: Cascade)
  syntheticAnswers SyntheticAnswer[]

  @@index([appRequestId])
  @@index([status])
  @@index([basePromptHash])
}

model SyntheticAnswer {
  id               String         @id
  appRequestId     String
  foundrySessionId String
  step             Int
  question         String
  proposedAnswer   String
  finalAnswer      String?
  status           String // "proposed" | "approved" | "adjusted"

  // Production Hardening - SyntheticAnswerContract
  contract         String  @default("{}")  // JSON: {proposedAnswer, confidence, reasoning, assumptions, suggestedAlternatives}
  requestHash      String  @default("")    // SHA-256 hash for deduplication

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  foundrySession   FoundrySession @relation(fields: [foundrySessionId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([foundrySessionId])
  @@index([status])
  @@index([requestHash])
}

model PlanningDocument {
  id           String     @id
  appRequestId String
  type         String // "MASTER_PLAN" | "IMPLEMENTATION_PLAN"
  content      String // Markdown string
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  documentVersion Int              @default(1)
  documentHash    String?          // SHA-256 hash of approved document
  sectionHashes   String           @default("{}") // JSON: {"vision": "hash", "targetAudience": "hash", ...}
  basePromptHash  String?          // Reference to Base Prompt this was derived from
  approvedBy      String?          // "human" | "synthetic_founder"

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([type])
  @@index([status])
  @@index([documentHash])
  @@index([basePromptHash])
}

model ScreenIndex {
  id           String     @id
  appRequestId String     @unique
  screens      String // JSON array of screen names
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  screenIndexVersion Int      @default(1)
  screenIndexHash    String?  // SHA-256 hash of approved index
  approvedBy         String?  // "human"
  basePromptHash     String   @default("") // Reference to Base Prompt
  planningDocsHash   String   @default("") // SHA-256 of Master + Implementation Plans

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
  @@index([screenIndexHash])
  @@index([basePromptHash])
}

model ScreenDefinition {
  id           String     @id
  appRequestId String
  screenName   String
  content      String // Markdown string
  order        Int
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  screenVersion    Int      @default(1)
  screenHash       String?  // SHA-256 hash of approved screen
  approvedBy       String?  // "human"
  screenIndexHash  String   @default("") // Reference to approved Screen Index
  basePromptHash   String   @default("") // Reference to Base Prompt
  planningDocsHash String   @default("") // SHA-256 of planning docs

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([order])
  @@index([status])
  @@index([screenHash])
  @@index([screenIndexHash])
}

model UserRoleDefinition {
  id           String     @id
  appRequestId String     @unique
  content      String // Markdown table
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  roleTableVersion  Int      @default(1)
  roleTableHash     String?  // SHA-256 hash of approved role table
  approvedBy        String?  // "human"
  basePromptHash    String   @default("") // Reference to Base Prompt
  planningDocsHash  String   @default("") // SHA-256 of Master + Implementation Plans
  screenIndexHash   String   @default("") // Reference to approved Screen Index

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
  @@index([roleTableHash])
  @@index([basePromptHash])
  @@index([screenIndexHash])
}

model UserJourney {
  id           String     @id
  appRequestId String
  roleName     String
  content      String // Markdown journey steps
  order        Int
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Versioning (Production Hardening)
  journeyVersion    Int      @default(1)
  journeyHash       String?  // SHA-256 hash of approved journey
  approvedBy        String?  // "human"
  roleTableHash     String   @default("") // Reference to approved Role Table
  screenIndexHash   String   @default("") // Reference to approved Screen Index
  basePromptHash    String   @default("") // Reference to Base Prompt
  planningDocsHash  String   @default("") // SHA-256 of planning docs

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([order])
  @@index([status])
  @@index([journeyHash])
  @@index([roleTableHash])
  @@index([screenIndexHash])
}

model ScreenMockup {
  id               String     @id
  appRequestId     String
  screenName       String
  layoutType       String // "mobile" | "desktop"
  imagePath        String
  promptMetadata   String // JSON string (includes contract, imageHash, etc.)
  status           String // "draft" | "awaiting_approval" | "approved"
  createdAt        DateTime   @default(now())
  approvedAt       DateTime?
  // Immutability & Hash Chain (Visual Forge Production Hardening)
  mockupHash       String? // SHA-256 of mockup contract (locked on approval)
  mockupVersion    Int        @default(1)
  approvedBy       String? // "human" | null
  imageHash        String? // SHA-256 of image file
  screenHash       String? // Reference to approved Screen Definition
  screenIndexHash  String? // Reference to approved Screen Index
  journeyHash      String? // Optional: relevant journey hash
  basePromptHash   String? // Traceability to base prompt
  planningDocsHash String? // Traceability to planning documents
  appRequest       AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([screenName])
  @@index([status])
  @@index([mockupHash])
  @@index([screenHash])
}

model VisualExpansionContract {
  id                     String    @id
  appRequestId           String
  screenName             String
  layoutType             String    // "desktop" | "mobile"
  contractJson           String    // JSON: sections, elements, charts, etc.

  // Immutability & Hash Chain
  contractHash           String
  contractVersion        Int       @default(1)
  approvedBy             String?   // "human" | null
  approvedAt             DateTime?

  // Traceability
  basePromptHash         String
  planningDocsHash       String
  screenIndexHash        String
  screenDefinitionHash   String
  journeyHash            String    @default("") // Optional: relevant journey hash

  // Status
  status                 String    // "draft" | "awaiting_approval" | "approved" | "rejected"
  createdAt              DateTime  @default(now())

  appRequest             AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([contractHash])
  @@index([screenName])
  @@index([status])
  @@index([screenDefinitionHash])
}

model VisualNormalizationContract {
  id                          String    @id
  appRequestId                String
  screenName                  String
  layoutType                  String    // "desktop" | "mobile"
  contractJson                String    // JSON: layout rules, density rules, typography, color, etc.

  // Immutability & Hash Chain
  contractHash                String
  contractVersion             Int       @default(1)
  approvedBy                  String?   // "human" | null
  approvedAt                  DateTime?

  // Traceability (hash chain from upstream artifacts)
  basePromptHash              String
  planningDocsHash            String
  screenIndexHash             String
  screenDefinitionHash        String
  visualExpansionContractHash String    // VRA contract this normalizes

  // Status
  status                      String    // "draft" | "awaiting_approval" | "approved" | "rejected"
  createdAt                   DateTime  @default(now())

  appRequest                  AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([contractHash])
  @@index([screenName])
  @@index([status])
  @@index([visualExpansionContractHash])
}

model VisualCompositionContract {
  id                              String    @id
  appRequestId                    String
  screenName                      String
  layoutType                      String    // "desktop" | "mobile"
  contractJson                    String    // JSON: composition plan (sections, grouping, priority, spacing, etc.)

  // Immutability & Hash Chain
  contractHash                    String
  contractVersion                 Int       @default(1)
  approvedBy                      String?   // "human" | null
  approvedAt                      DateTime?

  // Traceability (hash chain from upstream artifacts)
  basePromptHash                  String
  planningDocsHash                String
  screenIndexHash                 String
  screenDefinitionHash            String
  visualExpansionContractHash     String    // VRA contract this composes
  visualNormalizationContractHash String    // DVNL contract this respects

  // Status
  status                          String    // "draft" | "awaiting_approval" | "approved" | "rejected"
  createdAt                       DateTime  @default(now())

  appRequest                      AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([contractHash])
  @@index([screenName])
  @@index([status])
  @@index([visualNormalizationContractHash])
}

// Visual Code Rendering Authority (VCRA) - Tier 3.75
// Generates real HTML/CSS/React code from visual contracts
// Replaces DALL-E with browser-rendered screenshots
model VisualCodeRenderingContract {
  id                              String    @id
  appRequestId                    String
  screenName                      String
  layoutType                      String    // "desktop" | "mobile"

  // Framework & Code Generation
  framework                       String    // "html-tailwind" | "react-tailwind"
  generatedCode                   String    // Full HTML/JSX code
  codeHash                        String    // Hash of generated code

  // Viewport Configuration
  viewportWidth                   Int
  viewportHeight                  Int

  // Contract Data (JSON)
  contractJson                    String    // Layout structure, typography, spacing rules

  // Immutability & Hash Chain
  contractHash                    String
  contractVersion                 Int       @default(1)
  approvedBy                      String?
  approvedAt                      DateTime?

  // Traceability (complete hash chain from VRA → DVNL → VCA → VCRA)
  basePromptHash                  String
  planningDocsHash                String
  screenIndexHash                 String
  screenDefinitionHash            String
  visualExpansionContractHash     String    // VRA contract
  visualNormalizationContractHash String    // DVNL contract
  visualCompositionContractHash   String    // VCA contract

  // Status
  status                          String    // "draft" | "awaiting_approval" | "approved" | "rejected"
  createdAt                       DateTime  @default(now())

  appRequest                      AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([contractHash])
  @@index([codeHash])
  @@index([screenName])
  @@index([status])
  @@index([visualCompositionContractHash])
}

model ProjectRuleSet {
  id           String     @id
  appRequestId String     @unique
  content      String // Markdown document
  status       String // "draft" | "awaiting_approval" | "approved"
  createdAt    DateTime   @default(now())
  approvedAt   DateTime?

  // Immutability & Hash Chain (Production Hardening - Jan 13, 2026)
  rulesHash    String? // SHA-256 hash of approved rules (locked on approval)
  approvedBy   String? // "human" | null

  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
}

model BuildPrompt {
  id            String  @id
  appRequestId  String
  title         String
  content       String // Markdown document
  sequenceIndex Int
  status        String // "awaiting_approval" | "approved" | "rejected"
  feedback      String?

  // Execution contract fields
  allowedCreateFiles String @default("[]") // JSON array
  allowedModifyFiles String @default("[]") // JSON array
  forbiddenFiles     String @default("[]") // JSON array
  fullRewriteFiles   String @default("[]") // JSON array
  dependencyManifest String @default("{}") // JSON object
  modificationIntent String @default("{}") // JSON object

  // Production Hardening (2026-01-13)
  contractHash String? // SHA-256 hash of BuildPromptContract
  contractJson String? // Full contract for immutability
  approvedBy   String? // "human" or username

  createdAt  DateTime   @default(now())
  approvedAt DateTime?
  appRequest AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([sequenceIndex])
  @@index([status])
  @@index([contractHash])
}

model ExecutionPlan {
  id            String   @id
  appRequestId  String
  buildPromptId String
  status        String   // "awaiting_approval" | "approved" | "rejected"
  createdAt     DateTime @default(now())
  approvedAt    DateTime?

  // Production Hardening (2026-01-13)
  contractHash    String? // SHA-256 hash of ExecutionPlanContract
  contractJson    String? // Full contract for immutability
  approvedBy      String? // "human" or username
  buildPromptHash String? // Reference to approved BuildPrompt (hash-chain)

  appRequest    AppRequest      @relation(fields: [appRequestId], references: [id], onDelete: Cascade)
  units         ExecutionUnit[]

  @@index([appRequestId])
  @@index([buildPromptId])
  @@index([status])
  @@index([contractHash])
}

model ExecutionUnit {
  id                 String   @id
  executionPlanId    String
  sequenceIndex      Int
  title              String
  description        String

  // Execution contract for this unit
  allowedCreateFiles String @default("[]") // JSON array
  allowedModifyFiles String @default("[]") // JSON array
  forbiddenFiles     String @default("[]") // JSON array
  fullRewriteFiles   String @default("[]") // JSON array
  dependencyChanges  String @default("{}") // JSON object
  modificationIntent String @default("{}") // JSON object

  status        String   // "pending" | "in_progress" | "completed" | "failed"
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  executionPlan ExecutionPlan @relation(fields: [executionPlanId], references: [id], onDelete: Cascade)

  @@index([executionPlanId])
  @@index([sequenceIndex])
  @@index([status])
}

model Verification {
  id           String     @id
  appRequestId String
  executionId  String
  status       String     @default("pending")
  errors       String?
  attempt      Int        @default(1)
  createdAt    DateTime   @default(now())
  appRequest   AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([executionId])
  @@index([status])
}

model CompletionDecision {
  id              String     @id
  appRequestId    String
  executionUnitId String?
  decisionType    String     // "proceed_to_next_unit" | "retry_with_repair" | "escalate_to_human" | "mark_completed" | "mark_failed"
  reason          String?
  createdAt       DateTime   @default(now())
  appRequest      AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([decisionType])
  @@index([createdAt])
}

// ============================================================================
// TIER 5: VERIFICATION & SELF-HEALING (Phase 10 Constitutional Hardening)
// ============================================================================

model VerificationResult {
  id                 String   @id
  appRequestId       String
  buildPromptHash    String   // Reference to approved BuildPrompt (hash-chain)
  executionPlanHash  String   // Reference to approved ExecutionPlan (hash-chain)
  rulesHash          String   // Reference to approved ProjectRuleSet (hash-chain)

  // Immutable verification steps (JSON serialized VerificationStepResult[])
  stepsJson          String   // Array of {stepId, command, exitCode, stdout, stderr, durationMs, status}

  overallStatus      String   // "PASSED" | "FAILED"
  verifier           String   // "VerificationExecutorHardened"

  // Hash-locking (SHA-256)
  resultHash         String   @unique // Deterministic hash (excludes timestamps)

  // Metadata (excluded from hash)
  executedAt         DateTime @default(now())

  appRequest         AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([buildPromptHash])
  @@index([executionPlanHash])
  @@index([overallStatus])
  @@index([resultHash])
}

model VerificationReport {
  id                    String   @id
  appRequestId          String
  verificationResultId  String   // Reference to VerificationResult (source of truth)

  // Immutable report content (JSON serialized VerificationReportContract)
  reportJson            String   // Full report for immutability

  // Report metadata
  generator             String   // "VerificationReportGeneratorHardened"

  // Hash-locking (SHA-256)
  reportHash            String   @unique // Deterministic hash (excludes timestamps)

  // Hash references (for audit trail)
  verificationResultHash String  // Copy from VerificationResult.resultHash
  buildPromptHash        String  // Copy from VerificationResult.buildPromptHash
  executionPlanHash      String  // Copy from VerificationResult.executionPlanHash
  rulesHash              String  // Copy from VerificationResult.rulesHash

  // Metadata (excluded from hash)
  generatedAt            DateTime @default(now())

  appRequest             AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([verificationResultId])
  @@index([reportHash])
  @@index([verificationResultHash])
}

// ============================================================================
// TIER 6: REPAIR (Post-Verification Corrective Execution)
// ============================================================================

model RepairPlan {
  id                        String   @id
  appRequestId              String
  verificationResultId      String   // Reference to FAILED VerificationResult

  // Immutable repair plan content (JSON serialized RepairPlanContract)
  repairPlanJson            String   // Full plan for immutability

  // Allowed modifications (explicit file list)
  allowedFileModifications  String   // JSON array of file paths

  // Repair steps (JSON serialized)
  repairStepsJson           String   // Array of {stepId, file, intent, verificationStepReference}

  // Approval metadata
  approvedBy                String   // Human who approved repair
  status                    String   // "awaiting_approval" | "approved" | "rejected"

  // Hash-locking (SHA-256)
  repairPlanHash            String   @unique // Deterministic hash

  // Hash references (audit trail)
  sourceVerificationHash    String   // Copy from VerificationResult.resultHash

  // Metadata (excluded from hash)
  createdAt                 DateTime @default(now())
  approvedAt                DateTime?

  appRequest                AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([verificationResultId])
  @@index([status])
  @@index([repairPlanHash])
  @@index([sourceVerificationHash])
}

model RepairExecutionLog {
  id                   String   @id
  appRequestId         String
  repairPlanId         String   // Reference to approved RepairPlan

  // Immutable execution log (JSON serialized)
  executionLogJson     String   // Full log for immutability

  // Execution results
  overallStatus        String   // "COMPLETED" | "FAILED"
  executor             String   // "RepairAgentHardened"

  // Hash-locking (SHA-256)
  executionLogHash     String   @unique // Deterministic hash

  // Hash references (audit trail)
  repairPlanHash       String   // Copy from RepairPlan.repairPlanHash

  // Metadata (excluded from hash)
  executedAt           DateTime @default(now())

  appRequest           AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([repairPlanId])
  @@index([overallStatus])
  @@index([executionLogHash])
  @@index([repairPlanHash])
}

// ============================================================================
// FRAMEWORK ASSEMBLY LAYER (Added 2026-01-14)
// ============================================================================

/**
 * Framework Assembly Manifest
 *
 * Output from Framework Assembly Layer (Next.js Pack).
 * Hash-locked manifest of assembled Next.js application.
 */
model FrameworkAssemblyManifest {
  id                String   @id // UUID
  appRequestId      String
  framework         String   // "nextjs"
  frameworkVersion  String   // e.g., "14.2.0"
  outputDir         String   // Absolute path to nextjs-app/

  // Manifest data (JSON serialized)
  manifestJson      String   // Full manifest for immutability

  // Hash-locking (SHA-256)
  manifestHash      String   @unique // Deterministic hash
  executionLogHash  String   // Reference to Forge Implementer output

  // Metadata
  createdAt         DateTime @default(now())

  appRequest        AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([manifestHash])
  @@index([executionLogHash])
}

// ============================================================================
// PREVIEW RUNTIME (Added 2026-01-14)
// ============================================================================

/**
 * Preview Runtime Session
 *
 * Mechanical execution chamber for running Forge-assembled applications.
 * ZERO intelligence, ZERO autonomy.
 *
 * Philosophy: Run → Observe → Destroy
 */
model PreviewRuntimeSession {
  id                String   @id // UUID
  appRequestId      String
  framework         String   // "nextjs" (only option in v1.0)
  frameworkVersion  String   // e.g., "14.2.0"

  // Hash references (audit trail)
  manifestHash      String   // Reference to Framework Assembly manifest
  workspaceHash     String   // SHA-256 of workspace directory

  // Execution state
  status            String   // "READY" | "STARTING" | "BUILDING" | "RUNNING" | "FAILED" | "TERMINATED"

  // Container metadata
  containerId       String?  // Docker container ID
  port              Int?     // Mapped port (10000-20000)
  previewUrl        String?  // http://localhost:{port}

  // Lifecycle timestamps (milliseconds since epoch, stored as BigInt)
  startedAt         BigInt   // When STARTING began
  runningAt         BigInt?  // When RUNNING began (null if never reached)
  terminatedAt      BigInt?  // When TERMINATED/FAILED

  // Failure metadata (null if successful)
  failureStage      String?  // "install" | "build" | "start" | "timeout" | "crash"
  failureOutput     String?  // Raw stderr/stdout (NO interpretation)

  // Execution outputs (raw command results)
  installStdout     String?
  installStderr     String?
  installExitCode   Int?
  installDurationMs BigInt?

  buildStdout       String?
  buildStderr       String?
  buildExitCode     Int?
  buildDurationMs   BigInt?

  startStdout       String?
  startStderr       String?
  startExitCode     Int?
  startDurationMs   BigInt?

  // Hash-locking (SHA-256, deterministic)
  sessionHash       String   @unique // Excludes timestamps, sessionId

  // Metadata
  createdAt         DateTime @default(now())

  appRequest        AppRequest @relation(fields: [appRequestId], references: [id], onDelete: Cascade)

  @@index([appRequestId])
  @@index([status])
  @@index([sessionHash])
  @@index([manifestHash])
}
